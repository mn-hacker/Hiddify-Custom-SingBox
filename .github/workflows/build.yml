name: Build Singbox with V2Ray API

on:
  workflow_dispatch:
    inputs:
      singbox_version:
        description: 'Singbox version to build (leave empty for latest main)'
        required: false
        default: ''
      release_tag:
        description: 'Release tag name (e.g., v1.10.0.h1)'
        required: true

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: amd64
            goarch: amd64
          - arch: arm64
            goarch: arm64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: false

      - name: Clone sing-box
        run: |
          if [ -n "${{ github.event.inputs.singbox_version }}" ]; then
            git clone --depth=1 --branch "${{ github.event.inputs.singbox_version }}" https://github.com/SagerNet/sing-box.git
          else
            git clone --depth=1 --branch main https://github.com/SagerNet/sing-box.git
          fi

      - name: Get version info
        id: version
        run: |
          cd sing-box
          VERSION=$(git describe --tags --always 2>/dev/null || echo "main-$(git rev-parse --short HEAD)")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building sing-box version: $VERSION"

      - name: Build sing-box
        env:
          GOOS: linux
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 0
        run: |
          cd sing-box
          
          # Build tags - MUST include with_v2ray_api for Hiddify panel
          TAGS="with_v2ray_api,with_quic,with_gvisor,with_dhcp,with_wireguard,with_utls,with_acme,with_clash_api"
          
          go build \
            -tags "$TAGS" \
            -ldflags "-s -w -X github.com/sagernet/sing-box/constant.Version=${{ steps.version.outputs.version }}" \
            -o sing-box \
            ./cmd/sing-box
          
          # Verify build
          ./sing-box version || file ./sing-box

      - name: Create archive
        run: |
          mkdir -p release
          cp sing-box/sing-box release/
          cd release
          zip sing-box-linux-${{ matrix.arch }}.zip sing-box
          
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: sing-box-linux-${{ matrix.arch }}
          path: release/sing-box-linux-${{ matrix.arch }}.zip

  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download amd64 artifact
        uses: actions/download-artifact@v4
        with:
          name: sing-box-linux-amd64
          path: ./artifacts

      - name: Download arm64 artifact
        uses: actions/download-artifact@v4
        with:
          name: sing-box-linux-arm64
          path: ./artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.release_tag }}
          name: "Sing-box ${{ github.event.inputs.release_tag }}"
          body: |
            ## Sing-box Custom Build for Hiddify Panel
            
            **Build Info:**
            - Built with `with_v2ray_api` tag (required for Hiddify panel)
            - Based on: sing-box ${{ github.event.inputs.singbox_version || 'main branch' }}
            
            **Tags included:**
            - with_v2ray_api
            - with_quic
            - with_gvisor
            - with_dhcp
            - with_wireguard
            - with_utls
            - with_acme
            - with_clash_api
            
            **Download:**
            - `sing-box-linux-amd64.zip` - for x86_64 servers
            - `sing-box-linux-arm64.zip` - for ARM64 servers
          files: |
            ./artifacts/sing-box-linux-amd64.zip
            ./artifacts/sing-box-linux-arm64.zip
          draft: false
          prerelease: false
